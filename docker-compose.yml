version: "3.9"

services:
  resource-processor:
    image: ms/resource-processor
    restart: always
    build: ./resource-processor
    depends_on:
      - rabbitmq
      - resource-service
      - song-service
      - eureka
    environment:
      RABBIT_HOST: rabbitmq
      EUREKA_SERVICE_URL: 'http://eureka:8761'
      GATEWAY_URL: 'http://spring-cloud-gateway:8083'

  resource-service:
    image: ms/resource-service
    restart: always
    build: ./resource-service
    depends_on:
      - rabbitmq
      - s3-ninja
      - eureka
    environment:
      RABBIT_HOST: rabbitmq
      AWS_S3_ENDPOINT_URL: 'http://s3-ninja:9000'
      EUREKA_SERVICE_URL: 'http://eureka:8761'

  song-service:
    image: ms/song-service
    restart: always
    build: ./song-service
    depends_on:
      - eureka
    environment:
      EUREKA_SERVICE_URL: 'http://eureka:8761'

  rabbitmq:
    image: 'rabbitmq:3.8.9-management'
    ports:
      - "5672:5672"
      - "15672:15672"

  s3-ninja:
    image: 'scireum/s3-ninja:latest'
    ports:
      - "9444:9000"

  eureka:
    image: ms/eureka-server
    build: ./eureka-server
    ports:
      - "8761:8761"

  spring-cloud-gateway:
    image: ms/spring-gateway
    build: ./spring-cloud-gateway
    ports:
      - "8083:8083"
    environment:
      EUREKA_SERVICE_URL: 'http://eureka:8761'
      S3NINJA_HOST: 'http://s3-ninja:9000'
      RABBIT_HOST: 'http://rabbitmq:15672'